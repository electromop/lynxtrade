<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradingView Fixed Rectangle Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #000000;
            color: #ffffff;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        .chart-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        #tv_chart_container {
            width: 100%;
            height: 100%;
        }
        
        .fixed-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–±—ã—Ç–∏—è –∫ –º—ã—à–∏ –∫ —á–∞—Ä—Ç—É */
            z-index: 100;
        }
        
        .buy-rectangle {
            position: absolute;
            border: 2px solid #22c55e;
            background-color: rgba(34, 197, 94, 0.2);
            pointer-events: none; /* –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –º—ã—à–∏ */
            box-sizing: border-box;
            min-width: 100px;
            min-height: 50px;
            user-select: none; /* –ó–∞–ø—Ä–µ—â–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ */
        }
        
        .buy-rectangle .price-label {
            position: absolute;
            top: -25px;
            left: 0;
            background: #22c55e;
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
            pointer-events: none;
        }
        
        .sell-rectangle {
            position: absolute;
            border: 2px solid #ef4444;
            background-color: rgba(239, 68, 68, 0.2);
            pointer-events: none; /* –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –º—ã—à–∏ */
            box-sizing: border-box;
            min-width: 100px;
            min-height: 50px;
            user-select: none; /* –ó–∞–ø—Ä–µ—â–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ */
        }
        
        .sell-rectangle .price-label {
            position: absolute;
            top: -25px;
            left: 0;
            background: #ef4444;
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
            pointer-events: none;
        }
        
        .controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 5px;
        }
        
        button {
            background: #22c55e;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover {
            background: #16a34a;
        }
        
        .info {
            margin-top: 10px;
            font-size: 12px;
            color: #aaa;
        }
    </style>
    <!-- TradingView Charting Library -->
    <script type="text/javascript" src="https://charting-library.tradingview-widget.com/charting_library/charting_library.standalone.js"></script>
    <script type="text/javascript" src="https://charting-library.tradingview-widget.com/datafeeds/udf/dist/bundle.js"></script>
</head>
<body>
    <div class="chart-container">
        <div id="tv_chart_container"></div>
        <div class="fixed-overlay" id="chart-overlay"></div>
    </div>
    
    <div class="controls">
        <div style="margin-bottom: 10px;">
            <label for="priceInput" style="display: block; margin-bottom: 5px; font-size: 12px; color: #aaa;">Price:</label>
            <input type="number" id="priceInput" value="175.0" step="0.01" style="width: 100px; padding: 5px; background: #1a1a1a; border: 1px solid #333; color: white; border-radius: 3px; font-size: 14px;">
        </div>
        <button id="createRectBtn">Create Fixed Rectangle</button>
        <button id="clearRectBtn">Clear All</button>
        <div class="info" id="info">Enter price and click "Create Fixed Rectangle"</div>
    </div>

    <script>
        let widget = null;
        let zoneManager = null;

        class FixedBuyZoneManager {
            constructor(chartWidget, overlayId = 'chart-overlay') {
                this.chart = chartWidget;
                this.overlay = document.getElementById(overlayId);
                this.buyZones = new Map();
                this.currentZoneId = 0;
                this.animationFrameId = null;
                
                this.init();
            }
            
            init() {
                // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
                this.chart.onChartReady(() => {
                    const activeChart = this.chart.activeChart();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä overlay –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –≥—Ä–∞—Ñ–∏–∫–∞
                    this.updateOverlaySize();
                    
                    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–æ–Ω–Ω—ã–π —Ü–∏–∫–ª –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π
                    this.startAnimationLoop();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
                    window.addEventListener('resize', () => {
                        this.updateOverlaySize();
                    });
                });
            }
            
            /**
             * –î–æ–±–∞–≤–ª—è–µ—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ –ø–æ–∫—É–ø–∫–∏
             * @param {number} screenX - X –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö (–æ—Ç –ª–µ–≤–æ–≥–æ –∫—Ä–∞—è)
             * @param {number} screenY - Y –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö (–æ—Ç –≤–µ—Ä—Ö–Ω–µ–≥–æ –∫—Ä–∞—è)
             * @param {number} width - –®–∏—Ä–∏–Ω–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö
             * @param {number} height - –í—ã—Å–æ—Ç–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö
             * @param {number} price - –¶–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏ (–¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è)
             * @param {string} side - 'BUY' –∏–ª–∏ 'SELL'
             */
            addFixedBuyZone(screenX, screenY, width = 200, height = 80, price, side = 'BUY') {
                const zoneId = `buy-zone-${this.currentZoneId++}`;
                
                // –°–æ–∑–¥–∞–µ–º DOM —ç–ª–µ–º–µ–Ω—Ç
                const zoneElement = document.createElement('div');
                zoneElement.className = side === 'BUY' ? 'buy-rectangle' : 'sell-rectangle';
                zoneElement.id = zoneId;
                zoneElement.style.width = `${width}px`;
                zoneElement.style.height = `${height}px`;
                zoneElement.style.left = `${screenX}px`;
                zoneElement.style.top = `${screenY}px`;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–µ–π–±–ª —Å —Ü–µ–Ω–æ–π
                const label = document.createElement('div');
                label.className = 'price-label';
                label.textContent = `${side}: $${price.toFixed(2)}`;
                zoneElement.appendChild(label);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞ overlay
                this.overlay.appendChild(zoneElement);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–æ–Ω—É
                this.buyZones.set(zoneId, {
                    element: zoneElement,
                    screenX,
                    screenY,
                    width,
                    height,
                    price,
                    side
                });
                
                // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ - –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω
                // this.makeDraggable(zoneElement, zoneId); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ
                
                console.log(`‚úÖ Fixed zone created: ${zoneId} at (${screenX}, ${screenY}) - locked position`);
                
                return zoneId;
            }
            
            /**
             * –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —Ü–µ–Ω—É –≤ Y –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—É —ç–∫—Ä–∞–Ω–∞
             * @param {number} price - –¶–µ–Ω–∞ –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
             * @returns {number} Y –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö –∏–ª–∏ null –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å
             */
            priceToScreenY(price) {
                try {
                    const activeChart = this.chart.activeChart();
                    if (!activeChart) {
                        return null;
                    }
                    
                    const container = this.chart.container || document.getElementById('tv_chart_container');
                    if (!container) {
                        return null;
                    }
                    
                    const containerRect = container.getBoundingClientRect();
                    const containerHeight = containerRect.height;
                    
                    console.log(`üìä Converting price ${price} to Y coordinate, container height: ${containerHeight}`);
                    
                    // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ price scale —á–µ—Ä–µ–∑ —Å–µ—Ä–∏—é
                    try {
                        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å–µ—Ä–∏–∏
                        const allSeries = activeChart.getAllSeries ? activeChart.getAllSeries() : [];
                        console.log(`üìä Found ${allSeries.length} series`);
                        
                        // –ò—â–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Å–µ—Ä–∏—é (–æ–±—ã—á–Ω–æ –ø–µ—Ä–≤–∞—è)
                        let mainSeries = null;
                        if (allSeries.length > 0) {
                            mainSeries = allSeries[0];
                        } else {
                            // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —á–µ—Ä–µ–∑ –¥—Ä—É–≥–æ–π –º–µ—Ç–æ–¥
                            const series = activeChart.getSeries();
                            if (series && series.length > 0) {
                                mainSeries = series[0];
                            }
                        }
                        
                        if (mainSeries) {
                            console.log(`üìä Main series found:`, mainSeries);
                            
                            // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω —Ü–µ–Ω
                            if (typeof mainSeries.getPriceRange === 'function') {
                                const priceRange = mainSeries.getPriceRange();
                                console.log(`üìä Price range from series:`, priceRange);
                                
                                if (priceRange && priceRange.min !== undefined && priceRange.max !== undefined) {
                                    const minPrice = priceRange.min;
                                    const maxPrice = priceRange.max;
                                    const priceSpan = maxPrice - minPrice;
                                    
                                    if (priceSpan > 0) {
                                        // –í—ã—á–∏—Å–ª—è–µ–º Y –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—É (Y = 0 –≤–≤–µ—Ä—Ö—É, –ø–æ—ç—Ç–æ–º—É –∏–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º)
                                        // priceRange.min —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏ –≥—Ä–∞—Ñ–∏–∫–∞ (–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π Y)
                                        // priceRange.max —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –Ω–∏–∂–Ω–µ–π —á–∞—Å—Ç–∏ –≥—Ä–∞—Ñ–∏–∫–∞ (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π Y)
                                        const normalizedPrice = (price - minPrice) / priceSpan;
                                        const y = containerHeight * (1 - normalizedPrice);
                                        
                                        console.log(`üìä Price to Y conversion: price=${price}, min=${minPrice}, max=${maxPrice}, normalized=${normalizedPrice}, y=${y}`);
                                        return Math.max(0, Math.min(containerHeight, y));
                                    }
                                }
                            }
                            
                            // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±: –∏—Å–ø–æ–ª—å–∑—É–µ–º coordinateToPrice –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏
                            // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ Y –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ –Ω–∞—Ö–æ–¥–∏–º –Ω—É–∂–Ω—É—é
                            if (typeof mainSeries.coordinateToPrice === 'function') {
                                // –ë–∏–Ω–∞—Ä–Ω—ã–π –ø–æ–∏—Å–∫ –¥–ª—è –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è Y –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                                let topY = 0;
                                let bottomY = containerHeight;
                                const tolerance = 0.01; // –¢–æ—á–Ω–æ—Å—Ç—å 1 —Ü–µ–Ω—Ç
                                
                                for (let i = 0; i < 20; i++) { // –ú–∞–∫—Å–∏–º—É–º 20 –∏—Ç–µ—Ä–∞—Ü–∏–π
                                    const testY = (topY + bottomY) / 2;
                                    const testPrice = mainSeries.coordinateToPrice(testY);
                                    
                                    if (Math.abs(testPrice - price) < tolerance) {
                                        console.log(`üìä Found Y coordinate via binary search: y=${testY}, price=${testPrice}`);
                                        return testY;
                                    }
                                    
                                    if (testPrice > price) {
                                        topY = testY;
                                    } else {
                                        bottomY = testY;
                                    }
                                }
                                
                                const finalY = (topY + bottomY) / 2;
                                const finalPrice = mainSeries.coordinateToPrice(finalY);
                                console.log(`üìä Approximate Y coordinate: y=${finalY}, price=${finalPrice}`);
                                return finalY;
                            }
                        }
                    } catch (e) {
                        console.warn('Could not get price range from series:', e);
                    }
                    
                    // Fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –¥–ª—è AAPL
                    // –î–ª—è AAPL –≤ –º–∞—Ä—Ç–µ 2018 —Ü–µ–Ω–∞ –±—ã–ª–∞ –æ–∫–æ–ª–æ 170-180
                    const estimatedMinPrice = 160;
                    const estimatedMaxPrice = 190;
                    const estimatedPriceSpan = estimatedMaxPrice - estimatedMinPrice;
                    
                    if (estimatedPriceSpan > 0) {
                        const normalizedPrice = (price - estimatedMinPrice) / estimatedPriceSpan;
                        const y = containerHeight * (1 - normalizedPrice);
                        
                        console.log(`üìä Using estimated price range: price=${price}, y=${y}`);
                        return Math.max(0, Math.min(containerHeight, y));
                    }
                    
                    return null;
                } catch (error) {
                    console.error('Error converting price to Y:', error);
                    return null;
                }
            }
            
            /**
             * –î–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ –ø–æ —Ü–µ–Ω–µ (—Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π –≤ —ç–∫—Ä–∞–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã)
             * @param {number} price - –¶–µ–Ω–∞ –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
             * @param {string} side - 'BUY' –∏–ª–∏ 'SELL'
             */
            addBuyZoneByPrice(price, side = 'BUY') {
                try {
                    const activeChart = this.chart.activeChart();
                    if (!activeChart) {
                        console.error('Active chart not available');
                        return null;
                    }
                    
                    // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                    const container = this.chart.container || document.getElementById('tv_chart_container');
                    if (!container) {
                        console.error('Container not found');
                        return null;
                    }
                    
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º clientWidth/clientHeight –≤–º–µ—Å—Ç–æ getBoundingClientRect –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                    const containerWidth = container.clientWidth;
                    const containerHeight = container.clientHeight;
                    const centerX = containerWidth / 2;
                    
                    console.log(`üìä Container dimensions: ${containerWidth}x${containerHeight}`);
                    
                    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ü–µ–Ω—É –≤ Y –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—É
                    const screenY = this.priceToScreenY(price);
                    if (screenY === null) {
                        console.error('Could not convert price to screen Y');
                        // Fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—Ç—Ä —ç–∫—Ä–∞–Ω–∞
                        const centerY = containerHeight / 2;
                        const width = 200;
                        const height = 80;
                        return this.addFixedBuyZone(centerX - width / 2, centerY - height / 2, width, height, price, side);
                    }
                    
                    // –†–∞–∑–º–µ—Ä—ã –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞
                    const width = 200;
                    const height = 80;
                    
                    // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –ø–æ —Ü–µ–Ω—Ç—Ä—É –ø–æ X –∏ –ø–æ —Ü–µ–Ω–µ –ø–æ Y
                    // –í—ã—á–∏—Ç–∞–µ–º –ø–æ–ª–æ–≤–∏–Ω—É –≤—ã—Å–æ—Ç—ã, —á—Ç–æ–±—ã —Ü–µ–Ω—Ç—Ä –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞ –±—ã–ª –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ü–µ–Ω—ã
                    // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (0,0 –≤ –ª–µ–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
                    const x = centerX - width / 2;
                    const y = screenY - height / 2;
                    
                    console.log(`üìä Creating rectangle at price ${price}: screenY=${screenY}, x=${x}, y=${y}, container=${containerWidth}x${containerHeight}`);
                    
                    return this.addFixedBuyZone(x, y, width, height, price, side);
                } catch (error) {
                    console.error('Error adding zone by price:', error);
                    return null;
                }
            }
            
            /**
             * –î–µ–ª–∞–µ—Ç —ç–ª–µ–º–µ–Ω—Ç –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º—ã–º (–û–¢–ö–õ–Æ–ß–ï–ù–û - –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã)
             */
            makeDraggable(element, zoneId) {
                // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ - –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã
                // –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
                return;
            }
            
            /**
             * –û–±–Ω–æ–≤–ª—è–µ—Ç —Ä–∞–∑–º–µ—Ä overlay
             */
            updateOverlaySize() {
                try {
                    const container = this.chart.container || document.getElementById('tv_chart_container');
                    if (container) {
                        this.overlay.style.width = container.clientWidth + 'px';
                        this.overlay.style.height = container.clientHeight + 'px';
                    }
                } catch (e) {
                    console.warn('Error updating overlay size:', e);
                }
            }
            
            /**
             * –ê–Ω–∏–º–∞—Ü–∏–æ–Ω–Ω—ã–π —Ü–∏–∫–ª –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
             */
            startAnimationLoop() {
                const update = () => {
                    this.updateOverlaySize();
                    this.animationFrameId = requestAnimationFrame(update);
                };
                this.animationFrameId = requestAnimationFrame(update);
            }
            
            stopAnimationLoop() {
                if (this.animationFrameId) {
                    cancelAnimationFrame(this.animationFrameId);
                    this.animationFrameId = null;
                }
            }
            
            /**
             * –£–¥–∞–ª—è–µ—Ç –∑–æ–Ω—É
             */
            removeZone(zoneId) {
                const zone = this.buyZones.get(zoneId);
                if (zone) {
                    zone.element.remove();
                    this.buyZones.delete(zoneId);
                }
            }
            
            /**
             * –£–¥–∞–ª—è–µ—Ç –≤—Å–µ –∑–æ–Ω—ã
             */
            clearAll() {
                this.buyZones.forEach((zone, zoneId) => {
                    this.removeZone(zoneId);
                });
            }
        }

        function initChart() {
            if (typeof TradingView === 'undefined' || !TradingView.widget) {
                console.error('TradingView library not loaded');
                document.getElementById('info').textContent = 'Error: TradingView library not loaded';
                return;
            }

            console.log('Initializing TradingView chart...');

            widget = new TradingView.widget({
                library_path: 'https://charting-library.tradingview-widget.com/charting_library/',
                fullscreen: true, // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
                symbol: 'AAPL',
                interval: '1D',
                container: 'tv_chart_container',
                datafeed: new Datafeeds.UDFCompatibleDatafeed("https://demo-feed-data.tradingview.com"),
                locale: 'en',
                disabled_features: [
                    'use_localstorage_for_settings',
                    'volume_force_overlay',
                    'create_volume_indicator_by_default',
                ],
                enabled_features: [],
                theme: 'dark',
                overrides: {
                    'paneProperties.background': '#000000',
                    'paneProperties.vertGridProperties.color': '#1a1a1a',
                    'paneProperties.horzGridProperties.color': '#1a1a1a',
                },
            });

            widget.onChartReady(() => {
                console.log('‚úÖ Chart ready!');
                document.getElementById('info').textContent = 'Chart ready! Click "Create Fixed Rectangle" to test.';
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä –∑–æ–Ω
                zoneManager = new FixedBuyZoneManager(widget);
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    createTestRectangle();
                }, 2000);
            });
        }

        function createTestRectangle() {
            if (!zoneManager) {
                console.error('Zone manager not initialized');
                return;
            }

            try {
                // –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—É –∏–∑ input –ø–æ–ª—è
                const priceInput = document.getElementById('priceInput');
                const price = parseFloat(priceInput.value);
                
                if (isNaN(price) || price <= 0) {
                    document.getElementById('info').textContent = 'Please enter a valid price';
                    return;
                }
                
                // –°–æ–∑–¥–∞–µ–º –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ –Ω–∞ —É—Ä–æ–≤–Ω–µ –≤–≤–µ–¥–µ–Ω–Ω–æ–π —Ü–µ–Ω—ã
                const zoneId = zoneManager.addBuyZoneByPrice(price, 'BUY');
                
                if (zoneId) {
                    document.getElementById('info').textContent = `Fixed rectangle created at price $${price.toFixed(2)}! ID: ${zoneId}. Try scrolling the chart.`;
                    console.log(`‚úÖ Test rectangle created at price ${price}`);
                } else {
                    document.getElementById('info').textContent = 'Error creating rectangle';
                }
            } catch (error) {
                console.error('‚ùå Exception:', error);
                document.getElementById('info').textContent = `Exception: ${error.message}`;
            }
        }

        function clearAllRectangles() {
            if (zoneManager) {
                zoneManager.clearAll();
                document.getElementById('info').textContent = 'All rectangles cleared';
                console.log('All rectangles cleared');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('DOMContentLoaded', () => {
            console.log('DOM Content Loaded');
            initChart();
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
        document.getElementById('createRectBtn').addEventListener('click', createTestRectangle);
        document.getElementById('clearRectBtn').addEventListener('click', clearAllRectangles);
    </script>
</body>
</html>
